net = googlenet; %Loads CNN into MATLAB

imdsTrain = imageDatastore('Train', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames'); %Stores images all 'Train' folder, also sets subfolder names as labels.
[imdsTrain,imdsValidation] = splitEachLabel(imdsTrain,0.7); %Separates training and testing.
inputSize = net.Layers(1).InputSize(1:2); %Sets input size to size of images specified for the CNN.
augimdsTrain = augmentedImageDatastore(inputSize,imdsTrain);    %Resizes images.
augimdsValidation = augmentedImageDatastore(inputSize,imdsValidation);  %Resize images.

options = trainingOptions('sgdm', ...
    'MiniBatchSize',10, ...
    'MaxEpochs',6, ...
    'InitialLearnRate',1e-4, ...
    'Shuffle','every-epoch', ...
    'ValidationData',augimdsValidation, ...
    'ValidationFrequency',3, ...
    'Verbose',false, ...
    'Plots','training-progress'); %Sets up training session.

net = trainNetwork(augimdsTrain,lgraph_1,options); %Trains CNN using the training data, incorporating the specified training options.
